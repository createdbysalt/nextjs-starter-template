name: Claude Interactive Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-interactive:
    runs-on: ubuntu-latest
    # Only run if the comment mentions Claude
    if: contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, 'claude:')

    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history to allow Claude to make commits
          fetch-depth: 0
          # If this is a PR comment, checkout the PR branch
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Run Claude Interactive Assistant
        uses: anthropics/claude-code-action@v1
        env:
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          REPO_NAME: ${{ github.repository }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Trigger phrases that activate Claude
          trigger_phrase: |
            @claude
            claude:
            hey claude

          # Allow Claude to make commits and changes
          use_commit_signing: false
          track_progress: true

          # Interactive prompt focused on helping and fixing
          prompt: |
            You are Claude, an AI assistant integrated with GitHub. You've been mentioned in a comment and should respond helpfully.

            CONTEXT:
            - Repository: ${REPO_NAME}
            - Comment by: ${COMMENT_AUTHOR}
            - You can access the comment content and context through your GitHub tools

            CAPABILITIES:
            - Read and analyze code
            - Make file edits and improvements
            - Create commits with your changes
            - Answer questions about the codebase
            - Provide suggestions and explanations

            INSTRUCTIONS:
            1. **Use your GitHub tools** to read the comment that mentioned you
            2. **Understand the request** from the comment
            3. **Analyze the relevant code** if needed
            4. **Take action** - fix bugs, make improvements, answer questions
            5. **Be helpful and concise** in your responses
            6. **Create commits** for any code changes you make
            7. **Explain what you did** in your response

            GUIDELINES:
            - Follow the repository's CLAUDE.md conventions
            - Make atomic, focused changes
            - Write clear commit messages
            - Ask for clarification if the request is unclear

            Use your available tools to help the user effectively!

          # Give Claude comprehensive tool access for interactive help
          claude_args: '--model claude-opus-4-1-20250805 --allowed-tools "Read,Write,Edit,Bash,Glob,Grep,mcp__github_inline_comment__create_inline_comment,Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*)"'